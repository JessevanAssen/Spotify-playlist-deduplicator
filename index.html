<!DOCTYPE html>
<html ng-app="spotify-playlist-deduplicator">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spotify playlist deduplicator</title>
	<link href="lib/bootstrap/bootstrap.css" type="text/css" rel="stylesheet" />
</head>
<body>
	<div class="container" ng-controller="Controller">
		<h1>Spotify playlist deduplicator</h1>

		<div class="checkbox" ng-repeat="playlist in playlists">
			<label>
				<input type="checkbox" ng-model="playlist.checked">
				{{ playlist.item.getName() }}
			</label>
		</div>

		<button class="btn btn-primary" ng-click="removeDuplicates()" ng-disabled="busy || !hasCheckedPlaylists()">Remove duplicate tracks</button>
	</div>

	<script type="text/javascript" src="lib/angular/angular.js"></script>
	<script type="text/javascript" src="scripts/app.js"></script>
	<script type="text/javascript" src="scripts/appSettings.js"></script>
	<script type="text/javascript" src="scripts/models/Authorization.js"></script>
	<script type="text/javascript" src="scripts/models/Playlist.js"></script>
	<script type="text/javascript" src="scripts/models/Track.js"></script>
	<script type="text/javascript" src="scripts/services/spotifyAPI.js"></script>
	<script type="text/javascript">
		(function() {
			var module = angular.module("spotify-playlist-deduplicator");
			module.controller("Controller", function($scope, $http, $q, spotifyAPI, appSettings) {
				function authorize() {
					var match = /#access_token=((?:\w|\-)+)&token_type=(\w+)&expires_in=(\d+)/.exec(window.location.hash);
					if (match)
						return new models.Authorization(
							match[1],
							match[2],
							match[3]
						);
					else
						window.location = "https://accounts.spotify.com/authorize?client_id=" + appSettings.clientId + "&redirect_uri=" + appSettings.redirectUri + "&response_type=token&show_dialog=false&scope=" + ["playlist-read-private", "playlist-modify-public", "playlist-modify-private"].join("%20");
				}

				function createCheckedList(list) {
					return list.map(function(item) {
						return {
							checked: false,
							item: item
						};
					});
				}

				function getCheckedItems(checkedList) {
					return checkedList
						.filter(function(item) {
							return item.checked === true;
						})
						.map(function(item) {
							return item.item;
						});
				}

				function removeDuplicatesFromPlaylists(playlists) {
					var removeDuplicateFromPlaylist = function(playlist) {
						return spotifyAPI.removeDuplicateTracksInPlaylist(userId, playlist.getId(), authorization);
					};

					return $q.all(
						playlists.map(removeDuplicateFromPlaylist)
					);
				}

				$scope.busy = true;
				$scope.playlists = [];

				var authorization = authorize();
				var userId;
				var playlists;

				spotifyAPI.loadUserId(authorization)
					.then(function(userId_) {
						userId = userId_;
						return spotifyAPI.loadPlaylists(userId, authorization);
					})
					.then(function(data) {
						playlists = data.items;
						$scope.playlists = createCheckedList(playlists);
						$scope.busy = false;
					})
					.catch(function(reason) {
						console.log("Error", reason);
					});

				$scope.hasCheckedPlaylists = function() {
					return $scope.playlists.some(function(item) {
						return item.checked === true;
					});
				};

				$scope.removeDuplicates = function() {
					$scope.busy = true;
					removeDuplicatesFromPlaylists(getCheckedItems($scope.playlists))
						.then(function(data) {
							console.log(data);
						})
						.finally(function() {
							$scope.busy = false;
						});
				};
			});
		})();
	</script>
</body>
</html>
