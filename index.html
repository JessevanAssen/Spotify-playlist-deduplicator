<!DOCTYPE html>
<html ng-app="spotify-playlist-deduplicator">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spotify playlist deduplicator</title>
	<link href="lib/bootstrap/bootstrap.css" type="text/css" rel="stylesheet" />
</head>
<body>
	<div class="container" ng-controller="Controller">
		<h1>Spotify playlist deduplicator</h1>

		<div class="checkbox" ng-repeat="playlist in playlists">
			<label>
				<input type="checkbox" ng-value="playlist.getId()">
				{{ playlist.getName() }}
			</label>
		</div>

		<button class="btn btn-primary">Remove duplicate tracks</button>
	</div>

	<script type="text/javascript" src="lib/angular/angular.js"></script>
	<script type="text/javascript" src="scripts/app.js"></script>
	<script type="text/javascript" src="scripts/appSettings.js"></script>
	<script type="text/javascript" src="scripts/models/Authorization.js"></script>
	<script type="text/javascript" src="scripts/models/Playlist.js"></script>
	<script type="text/javascript" src="scripts/models/Track.js"></script>
	<script type="text/javascript" src="scripts/services/spotifyAPI.js"></script>
	<script type="text/javascript">
		(function() {
			var module = angular.module("spotify-playlist-deduplicator");
			module.controller("Controller", function($scope, $http, spotifyAPI, appSettings) {
				window.spotifyAPI = spotifyAPI;

				var match = /#access_token=((?:\w|\-)+)&token_type=(\w+)&expires_in=(\d+)/.exec(window.location.hash);
				if (match) {
					var authorization = new models.Authorization(
						match[1],
						match[2],
						match[3]
					);

					var userId;
					spotifyAPI.loadUserId(authorization)
						.then(function(userId_) {
							userId = userId_;
							return spotifyAPI.loadPlaylists(userId, authorization);
						})
						.then(function(data) {
							$scope.playlists = data.items;
							data.items.forEach(function(playlist) {
								spotifyAPI.removeDuplicateTracksInPlaylist(userId, playlist.getId(), authorization)
									.then(function(result) {
										console.log(playlist.getName(), JSON.stringify(result));
									});
							});
						})
						.catch(function(reason) {
							console.log("Error", reason);
						});
				} else {
					window.location = "https://accounts.spotify.com/authorize?client_id=" + appSettings.clientId + "&redirect_uri=" + appSettings.redirectUri + "&response_type=token&show_dialog=false&scope=" + ["playlist-read-private", "playlist-modify-public", "playlist-modify-private"].join("%20");
				}

				$scope.playlists = [];
			});
		})();
	</script>
</body>
</html>
